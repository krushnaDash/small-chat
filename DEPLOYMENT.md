# SmallChat Deployment Guide

This guide will help you deploy SmallChat to Azure App Service with CI/CD using GitHub Actions.

## Prerequisites

- Azure account with active subscription
- GitHub account
- Azure CLI installed locally
- Java 11+ installed locally

## Local Development Setup

### Test Locally

1. Start the application:
   ```bash
   mvn spring-boot:run -s .mvn/settings.xml
   ```

2. Open your browser and go to `http://localhost:8080`

3. Enter your name and start chatting!

## Azure Deployment

### Option 1: Automated Deployment with GitHub Actions

1. **Fork/Clone the repository** to your GitHub account

2. **Set up Azure resources** using the provided script:
   ```bash
   ./deploy-to-azure.sh
   ```

3. **Configure GitHub Secrets**:
   - Go to your GitHub repository → Settings → Secrets and variables → Actions
   - Add a new secret named `AZURE_WEBAPP_PUBLISH_PROFILE`
   - Copy the contents of `publish-profile.xml` (generated by the script) as the value

4. **Update the workflow file**:
   - Edit `.github/workflows/azure-deploy.yml`
   - Update `AZURE_WEBAPP_NAME` with the name generated by the script

5. **Push to GitHub**:
   ```bash
   git add .
   git commit -m "Initial SmallChat deployment"
   git push origin main
   ```

6. **Monitor deployment**:
   - Go to GitHub → Actions tab to see the deployment progress
   - Once complete, your app will be available at `https://your-app-name.azurewebsites.net`

### Option 2: Manual Deployment

1. **Build the application**:
   ```bash
   mvn clean package -DskipTests -s .mvn/settings.xml
   ```

2. **Deploy to Azure**:
   ```bash
   az webapp deploy \
     --resource-group smallchat-rg \
     --name your-app-name \
     --src-path target/smallchat-0.0.1-SNAPSHOT.jar \
     --type jar
   ```

## Configuration

### Environment Variables

Set these in Azure App Service → Configuration → Application settings:

- `SMALLCHAT_MESSAGE_RETENTION_DAYS`: Number of days to keep messages (default: 3)
- `JAVA_OPTS`: JVM options (default: `-Dserver.port=80`)

### Application Profiles

- **Development**: Uses `application.properties`
- **Production**: Uses `application-prod.properties` (optimized for Azure)

## Monitoring

### Health Check

- Endpoint: `/api/health`
- Returns application status and metrics

### Application Insights (Optional)

To enable Azure Application Insights monitoring:

1. Create an Application Insights resource in Azure
2. Add the connection string to your app settings:
   ```
   APPLICATIONINSIGHTS_CONNECTION_STRING=your-connection-string
   ```

## Troubleshooting

### Common Issues

1. **Maven Build Failures**:
   - Use the local settings file: `-s .mvn/settings.xml`
   - Ensure Java 11+ is installed

2. **WebSocket Connection Issues**:
   - Check if Azure App Service supports WebSockets (enable in Configuration)
   - Verify CORS settings if accessing from different domains

3. **Memory Issues**:
   - Monitor memory usage through Azure metrics
   - Adjust message retention period if needed
   - Consider scaling up the App Service plan

### Logs

View application logs in Azure:
```bash
az webapp log tail --name your-app-name --resource-group smallchat-rg
```

## Scaling

### Horizontal Scaling

SmallChat uses in-memory storage, so horizontal scaling will create separate chat rooms per instance. For true horizontal scaling, consider:

1. Using Redis for shared message storage
2. Implementing sticky sessions
3. Using Azure SignalR Service for WebSocket scaling

### Vertical Scaling

Increase the App Service plan size based on:
- Number of concurrent users
- Message volume
- Memory usage patterns

## Security Considerations

1. **HTTPS**: Enabled by default on Azure App Service
2. **WebSocket Security**: Uses secure WebSocket (WSS) in production
3. **Session Security**: Secure cookies enabled in production profile
4. **CORS**: Configure as needed for your domain

## Cost Optimization

1. **Auto-scaling**: Configure based on CPU/memory metrics
2. **Dev/Test pricing**: Use for non-production environments
3. **Resource cleanup**: Delete unused resources regularly

## Support

For issues or questions:
1. Check the application logs
2. Review the GitHub Actions workflow logs
3. Monitor Azure App Service metrics
4. Check the application health endpoint
